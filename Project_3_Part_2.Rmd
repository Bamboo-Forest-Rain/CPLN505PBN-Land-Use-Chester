---
title: "CPLN505-Assignment 3 Part 2: Mode Choice Modelling"
author: "Yihong Hu & Anna Duan"
date: "4/14/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # data processing and plotting package
library(sf) # standard R spatial package
library(kableExtra)
library(gmodels)
library(ggcorrplot)
library(gganimate)
library(gifski)
library(caret)
library(RSocrata)
library(FNN)
library(car)
library(DescTools)
library(LogisticDx)
```

# Introduction    
In this report, we model the following using trip data from the Delaware Valley Regional Planning Commission:        
1. Whether a commuter drove to work      
2. Whether a commuter walked or biked to work    
3. Whether a commuter drove to work, carpooled, took public transit, or walked or biked          
```{r Read Data, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE, results='hide'}

# Read Chester land use Data and its geometry
trips <- read.csv("/Users/annaduan/Documents/GitHub/CPLN505PBN-Land-Use-Chester/HH\ Travel\ Survey/trip_pub.csv") %>%
 # filter(ACT1 == 11 | ACT1 ==12) %>% #filter for work trips
  mutate(drove_work = ifelse(TRAN1 == 21, 1, 0),
         bike_walk_work = ifelse(TRAN1 == 11 | TRAN1 == 14, 1, 0),
         transit_work = ifelse(TRAN1 == 41 | TRAN1 == 44 | TRAN1 == 47 | TRAN1 == 51 | TRAN1 == 52 | TRAN1 == 53, 1, 0),
         carpool_work = ifelse(TRAN1 == 31, 1,0)) 
# %>%
#   dplyr::select(-DVRPC, -SPDFLAG, -OEGRES, -EGRESS, -EXIT, -OTRFS, -FARE3, -PAY3O, -PAY3, -TRFL2, -TRFS2, -FARE2, -PAY2O, -PAY2, -TRFL1, -TRFS1, -TRFR, -FARE1, -PAY1O, -PAY1, -LINE, -OACESS, -ACCESS, -SUBTR, -APDPN, -APDPH, -ADDPN, -ADDPH, -ADDP, -TOLLA, -TOLL, -PRKUO, -NNHTR, -PHHTR, -ADP, -HHVU, -OTRAN, -PLANO, -X, -ACT2, -ACT3, -ACT4, -ACT5, -ACT6, -ACT1O, -ACTO, -TRAN4, -TRAN3, -PARKO, -APDP, -X.1, -TRAN1, -TRAN2)



households <- read.csv("/Users/annaduan/Documents/GitHub/CPLN505PBN-Land-Use-Chester/HH\ Travel\ Survey/hh_pub_CSV.csv", header = TRUE) %>%
  dplyr::select(ADVLT, TOTVEH, DWELL, YRMOV, RENT, DIARY, ENGL, HHSIZE, NPHON, NOPHO, SHPHN, ETHNC, INCLV, INCOM, INCOME, ASSN, DPHON, NPLAC, NTRIPS, NOWRK, NOSTU, OWNSH, EACCT, CPA, DAYOFWK, HBW, HBO, NHB, MOTTRIP, SAMPN, LISTD, HADDR)

persons <- read.csv("/Users/annaduan/Documents/GitHub/CPLN505PBN-Land-Use-Chester/HH\ Travel\ Survey/per_pub.csv") %>%
  dplyr::select(SAMPN, PERNO, GEND, AGE, LIC, RESP, RELAT, DISAB, DISTY1, DISTY2, EDUC, SHOME, SDAY, SMODE1)
```

First, we clean the data and merge three datasets capturing participants' trip, household, and demographic attributes. We clean out NAs, and filter the data to make sure the values are all in the correct ranges.  
```{r clean Data, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE, results='hide'}

trips$drove_work[which(is.na(trips$drove_work))]<-0
trips$bike_walk_work[which(is.na(trips$bike_walk_work))]<-0
trips$transit_work[which(is.na(trips$transit_work))]<-0
trips$carpool_work[which(is.na(trips$carpool_work))]<-0
trips$SUMZERO<- trips$drove_work + trips$bike_walk_work + trips$transit_work + trips$carpool_work
trips <- trips[-which(trips$SUMZERO == 0), ] 

trips <- trips[which(trips$Dest_PTYE == 2), ] 
trips$Commute[trips$drove_work == 1] <- 1
trips$Commute[trips$bike_walk_work == 1] <- 2
trips$Commute[trips$transit_work == 1] <- 3
trips$Commute[trips$carpool_work == 1] <- 4



trips$SAMPN_PER <- do.call(paste, c(trips[c("SAMPN", "PERNO")], sep = ""))
trips <- subset(trips, !duplicated(SAMPN_PER))

person_hh <- merge(persons, households,
                    by.x = "SAMPN", 
                    by.y = "SAMPN", 
                    all.x = TRUE, 
                    all.y=FALSE, 
                    sort = FALSE)
# colnamCleaning<-c("VETMO", "W2TY", "W2TYO",  "W2TYP", "W2LOC", "W2IND", "W2INO", "W2OCC", "W2OCO", "W2DAY", "W2HOM", "W2HOO", "W2ST", "W2ET",  "W1WKD3", "W1WKD4", "W1WKE", "W1WKD1", "W1WKD2")
# person_hh<-person_hh[ , -which(names(persons) %in% colnamCleaning)]

person_hh$SAMPN_PER <- do.call(paste, c(person_hh[c("SAMPN", "PERNO")], sep = ""))

trips_person_hh <- merge(trips, person_hh,
                            by.x = "SAMPN_PER", 
                            by.y = "SAMPN_PER", 
                            all.x = TRUE, 
                            all.y=FALSE, 
                            sort = FALSE)

# varsInterest <- c("SAMPN", "PERNO", "AGE", "GENDER", "INCOME", "SAMPN_PER", "TOLLA", "TOLL", "PARKC", "PARKU", "PRKUO", "TRPDUR", "drove_work", "bike_walk_work", "transit_work", "carpool_work", "Commute")
# trips_person_hh<-trips_person_hh[ , which(names(trips_person_hh) %in% varsInterest)]

# trips_person_hh<-trips_person_hh[-which(is.na(trips_person_hh$INCOME)),]

drive<-trips_person_hh[which(trips_person_hh$drove_work ==1),]
walk_bike<-trips_person_hh[which(trips_person_hh$bike_walk_work ==1),]
transit<-trips_person_hh[which(trips_person_hh$transit_work ==1),]
carpool<-trips_person_hh[which(trips_person_hh$carpool_work ==1),]


summary(drive$TRPDUR)     #mean: 26
summary(walk_bike$TRPDUR) #mean: 21
summary(transit$TRPDUR)   #mean: 51
summary(carpool$TRPDUR)   #mean: 40

drive$distance<-(30/60)*drive$TRPDUR
walk_bike$distance<-(12/60)*walk_bike$TRPDUR
transit$distance<-(25/60)*transit$TRPDUR
carpool$distance<-(30/60)*carpool$TRPDUR

#re-combine the three data sets 
dat<-rbind(drive, walk_bike, transit, carpool)

#potential times for each
dat$time.auto <-dat$distance/30
dat$time.bike.walk <- dat$distance/12
dat$time.transit <- dat$distance/25
dat$time.carpool <- dat$distance/30

dat$mode[dat$drove_work == 1] <- "drove"
dat$mode[dat$transit_work == 1] <- "transit"
dat$mode[dat$bike_walk_work == 1] <- "bike"
dat$mode[dat$carpool_work == 1] <- "carpool"

rownames(dat) <- NULL 
# 
# varsInterest <- c("AGE", "GENDER", "INCOME", "time.auto", "time.bike.walk", "time.transit", "time.carpool", "mode")
# dat<-dat[ , which(names(dat) %in% varsInterest)]

#clean data further
trips_person_hh <-trips_person_hh[which(trips_person_hh$AGE %in% 1:110),]
trips_person_hh <-trips_person_hh[which(trips_person_hh$TRPDUR %in% 0:400),]
trips_person_hh <-trips_person_hh[which(trips_person_hh$INCOME %in% 0:200000),]

```

## Model 1: Drive to Work       
First, we test a model using the maximum number of variables, just as a baseline. This model includes trip duration, gender, age, disability, education, total vehicles in a household, adults in household, rent or not, whether they speak English, household size, number of phones in the household, income, and whether a household has working adults. The AIC is 1493, with just about half of the variables marked as statistically significant.   
```{r modelling, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE, results='hide'}

mod_drive <- glm ( drove_work ~  TRPDUR  + GEND + AGE+DISAB+EDUC + TOTVEH + ADVLT + RENT + ENGL + HHSIZE + NPHON + INCOME + NOWRK, data=trips_person_hh, family = binomial)
summary(mod_drive)

#take out some outliers
trips_person_hh <-trips_person_hh[which(trips_person_hh$AGE %in% 1:110),]
trips_person_hh <-trips_person_hh[which(trips_person_hh$TRPDUR %in% 0:400),]
trips_person_hh <-trips_person_hh[which(trips_person_hh$INCOME %in% 0:200000),]
```

Using vif(), we can see that the variance inflation factor for all variables is below 5, meaning the model does not suffer from too much collinearity.  

```{r vif, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE}
vif(mod_drive)
```

To create the "leanest and meanest" model, we use forward and backward selection to select the variables which contribute statistically significantly to the model and lower its AIC.     
```{r fwd bkwd selection, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE}
#Backward Selection
step(glm(drove_work ~  TRPDUR  + GEND + AGE+DISAB+EDUC + TOTVEH + ADVLT + RENT + ENGL + HHSIZE + NPHON + INCOME + NOWRK, data=trips_person_hh), direction = "backward")

#Forward Selection
fullmod<-glm(drove_work ~ TRPDUR  + GEND + AGE+DISAB+EDUC + TOTVEH + ADVLT + RENT + ENGL + HHSIZE + NPHON + INCOME + NOWRK, family = binomial, data = trips_person_hh)

intonly<-glm(drove_work ~ 1, family = binomial, data = trips_person_hh)

step(intonly, scope=list(lower=intonly, upper=fullmod), direction="forward")
```

Forward and backward selection outputs the list of variables that give the model the lowest AIC of 1452: TOTVEH (total vehicles) + NOWRK (nobody working in household) + TRPDUR (trip duration) + AGE + EDUC (education) + RENT (renter or not) + GEND (gender). After running the model, I remove gender because it is not statistically significant. This model now has all statistically significant variables. qchisq() then tells us that the critical value is 5666.533. Since the null deviance of the model is 1946, we know that our predicted results will have no significant difference from the observations.     
```{r fwd bkwd selection, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE}
#lowest aic: 1493, vars: TOTVEH + NOWRK + TRPDUR + AGE + GEND

mod_drive_3 <- glm(drove_work ~ TOTVEH + NOWRK + TRPDUR + AGE + EDUC + RENT, family = binomial, data = trips_person_hh)
summary(mod_drive_3)

#test fit
qchisq(.95, df=2918) 
```

Anova also tells us that the variables all contribute significantly, and add to the model's accuracy in the following order: total vehicles, no work, trip duration, age, education, and renters.      
```{r anova, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE}
#anova
anova(mod_drive_3, test="Chisq") #anova tells us that the following are statistically significant contributions: Trip duration, gender, age, total vehicles, household size, no work 

```  

We also calculate the predicted probabilities using the model. Here, we set the cut off for driving to work as 0.5. The results tell us that our model predicts correctly 92% of the time. 
```{r accuracy, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE}
#calculate predicted probabilities 
pred <- as.data.frame(fitted(mod_drive_3))
pred <- rename(pred, "prob" = "fitted(mod_drive_3)")
pred <- mutate(pred, "binary" = ifelse(prob < 0.5, 0, 1))
#append to original df
trips_person_hh$binary <- pred$binary
       
(sum(trips_person_hh$drove_work == 1 & trips_person_hh$binary == 1) + sum(trips_person_hh$drove_work == 0  #92%: not bad
  & trips_person_hh$binary == 0)) / nrow(trips_person_hh)


```

## Model 2: Walk or Bike to Work   
Just like with drive to work, we start with a "kitchen sink" model to get an overview of all the variables. Just like before, only about half of the variables are statistically significant, and the AIC is 915.  
```{r walk bike, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE, results='hide'}
mod_bike <- glm ( bike_walk_work ~  TRPDUR  + GEND + AGE+DISAB+EDUC + TOTVEH + ADVLT + RENT + ENGL + HHSIZE + NPHON + INCOME + NOWRK, data=trips_person_hh, family = binomial)
summary(mod_bike)
```

Using vif(), we can see that the variance inflation factor for all variables is below 5, meaning the model does not suffer from too much collinearity.  
```{r vif bike, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE}
vif(mod_bike)
```

To create the "leanest and meanest" model, we use forward and backward selection to select the variables which contribute statistically significantly to the model and lower its AIC.     
```{r fwd bkwd selection bike, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE}
#Backward Selection
step(glm(bike_walk_work ~  TRPDUR  + GEND + AGE+DISAB+EDUC + TOTVEH + ADVLT + RENT + ENGL + HHSIZE + NPHON + INCOME + NOWRK, data=trips_person_hh), direction = "backward")

#Forward Selection
fullmod<-glm(bike_walk_work ~ TRPDUR  + GEND + AGE+DISAB+EDUC + TOTVEH + ADVLT + RENT + ENGL + HHSIZE + NPHON + INCOME + NOWRK, family = binomial, data = trips_person_hh)

intonly<-glm(bike_walk_work ~ 1, family = binomial, data = trips_person_hh)

step(intonly, scope=list(lower=intonly, upper=fullmod), direction="forward")
```

Forward and backward selection outputs the list of variables that give the model the lowest AIC of 1452: TOTVEH (total vehicles) + NOWRK (nobody working in household) + TRPDUR (trip duration) + AGE + EDUC (education) + RENT (renter or not) + DISAB (disability) + INCOME. After running the model, I remove NPHON, INCOME, and DISAB because they are not statistically significant. This model now has all statistically significant variables. qchisq() then tells us that the critical value is 5666.533. Since the null deviance of the model is 1946, we know that our predicted results will have no significant difference from the observations.     
```{r fwd bkwd selection, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE}
#lowest aic: 1493, vars: TOTVEH + NOWRK + TRPDUR + AGE + GEND

mod_bike_3 <- glm(drove_work ~ TRPDUR + AGE + TOTVEH + RENT + NPHON + INCOME + NOWRK + EDUC + DISAB, family = binomial, data = trips_person_hh)
summary(mod_bike_3)

#test fit
qchisq(.95, df=2918) 
```

```{r bike select vars, message=FALSE, warning=FALSE, cache=TRUE, include=TRUE, results='hide'}
pred <- as.data.frame(fitted(mod_bike))
pred <- rename(pred, "prob" = "fitted(mod_bike)")
pred <- mutate(pred, "binary_b" = ifelse(prob < 0.5, 0, 1))
#append to original df
trips_person_hh$binary_b <- pred$binary_b
head(trips_person_hh)
       
(sum(trips_person_hh$drove_work == 1 & trips_person_hh$binary_b == 1) + sum(trips_person_hh$drove_work == 0  #9.7%%: yikes
  & trips_person_hh$binary_b == 0)) / nrow(trips_person_hh)




#anova
anova(mod_bike, test="Chisq") #anova tells us that the following are statistically significant contributions: Trip duration, gender, age, total vehicles, household size, no work 


vif(mod_bike_2) #very good


```

## Model 3: Drive to work, carpool, transit, walk, or bike  

```{r drive carpool transit walk or bike}
```